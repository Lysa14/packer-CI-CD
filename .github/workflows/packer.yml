name: Build and Publish OMI

on:
  push:
    branches:
      - packer

jobs:
  build-and-publish:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v2

    - name: Set up Python environment
      uses: actions/setup-python@v2
      with:
        python-version: '3.x'

    - name: Install required tools
      run: |
        sudo apt-get update
        sudo apt-get install -y unzip wget
        wget https://releases.hashicorp.com/packer/1.7.8/packer_1.7.8_linux_amd64.zip
        unzip ./packer_1.7.8_linux_amd64.zip
        ls -R

    - name: Create Packer template
      run: |
         cat <<EOF > packer-template.pkr.hcl
              packer {
                required_plugins {
                  outscale = {
                    version = ">= 1.2.0"
                    source = "github.com/outscale/outscale"
                  }
                }
              }

              source "outscale-bsu" "github-actions" {
                access_key = "${{ secrets.OUTSCALE_ACCESS_KEY }}"
                secret_key = "${{ secrets.OUTSCALE_SECRET_KEY }}"
                region = "${{ secrets.OUTSCALE_REGION }}"
                source_omi = "ami-321efe20"
                vm_type = "t2.micro"
                ssh_username = "outscale"
                omi_name = "packer-quick-start {{timestamp}}"
                tags = {
                  OS_Version = "Debian"
                  Release = "Latest"
                  Base_OMI_Name = "{{ .SourceOMIName }}"
                  Extra = "{{ .SourceOMITags.TagName }}"
                }
                user_data = ""sudo mv /tmp/script.sh /opt/bootscript.sh,
                              sudo mv /tmp/setup_boot.service /usr/lib/systemd/system/setup_boot.service,
                              sudo systemctl enable setup_boot.service "


              }

              build {
                sources = ["source.outscale-bsu.github-actions"]
              }
              
         EOF


    - name: Check security image befoe deploy
      run: |
            curl -sSfL https://raw.githubusercontent.com/anchore/grype/main/install.sh | sh -s -- -b /usr/local/bin
            grype --no-progress --exit-code 1 --no-fail-on-error image:ami-321efe20
      continue-on-error: false     
    

    - name: Run Packer
      run: |
        packer plugins install github.com/outscale/outscale
        packer init .
        packer validate packer-template.pkr.hcl
        packer build packer-template.pkr.hcl
